<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Elia RÃ¶mpler - Portfolio</title>
    <link rel="icon" type="image/png" href="public/img/IMG_6999.PNG" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://use.typekit.net/yyn5dss.css" />
  </head>

  <body>
    <!-- Move hamburger OUTSIDE the transformed .navigation -->
    <button
      class="hamburger"
      type="button"
      aria-label="Open menu"
      onclick="openMenu()"
      id="hamburgerBtn"
    >
      <div id="bar1" class="bar"></div>
      <div id="bar2" class="bar"></div>
      <div id="bar3" class="bar"></div>
    </button>

    <div class="navigation">
      <nav>
        <ul>
          <li>
            <a href="asterisk.html">Home</a>
          </li>
          <li>
            <a href="#" onclick="closeMenuAndOpenGallery(); return false;"
              >Gallery</a
            >
          </li>
          <li><a href="about.html">About</a></li>
        </ul>
      </nav>

      <div class="socials">
        <a
          href="https://www.linkedin.com/in/elia-r%C3%B6mpler-5b4b9823b/"
          target="_blank"
          >LinkedIn</a
        >
        <a href="https://www.instagram.com/elia.roempler/" target="_blank"
          >Instagram</a
        >
        <a href="elia.roempler@gmail.com" target="_blank">E-mail</a>
      </div>

      <div class="asterisk-image">
        <img src="public/img/IMG_6999.PNG" alt="asterisk" />
      </div>
    </div>
    <div id="page-transition-overlay"></div>
    <!-- Intro overlay with video -->
    <div id="start-overlay" aria-hidden="false">
      <!-- Pre-video: muted, looping, visible by default -->
      <video
        id="preVideo"
        class="intro-video active"
        autoplay
        muted
        loop
        playsinline
        webkit-playsinline
        x5-playsinline
        preload="auto"
      >
        <source src="public/vid/premain.mp4" type="video/mp4" />
      </video>

      <!-- Main video: muted initially, hidden, will unmute on click -->
      <video
        id="introVideo"
        class="intro-video"
        muted
        playsinline
        webkit-playsinline
        x5-playsinline
        preload="auto"
      >
        <source src="public/vid/main4.mp4" type="video/mp4" />
      </video>

      <!-- Skip video button in bottom right -->
      <button id="skipVideoBtn" aria-label="Skip video">Skip</button>
      <!-- Fallback play button if autoplay is blocked -->
      <button id="introPlayBtn" aria-label="Play intro" hidden>Play</button>
    </div>

    <!-- Priority-based video loading -->
    <script src="video-loader.js"></script>
    <!-- Your UI/gallery/masonry JS -->
    <script src="script.js"></script>

    <script>
      // Redirect to asterisk page after video fade
      (function () {
        const overlay = document.getElementById("start-overlay");
        const preVideo = document.getElementById("preVideo");
        const mainVideo = document.getElementById("introVideo");

        if (!overlay || !preVideo || !mainVideo) return;

        let hasTransitioned = false; // Track if we've switched to main video
        let scrollAccumulator = 0;
        const maxScroll = 100; // Total scroll distance
        const fadeStartThreshold = 70; // Start fading at 70% of scroll distance
        let targetScroll = 0;
        let scrollVelocity = 0;
        let lastFrameTime = performance.now();
        let hasRedirected = false;

        // ============================================
        // CLICK TO TRANSITION FROM PRE-VIDEO TO MAIN
        // ============================================

        function transitionToMainVideo() {
          if (hasTransitioned) return; // Only allow once
          hasTransitioned = true;

          // Fade out pre-video
          preVideo.classList.remove("active");

          // Ensure main video is loaded and ready
          const playMainVideo = () => {
            // Fade in main video and unmute it
            mainVideo.classList.add("active");
            mainVideo.muted = false;
            mainVideo.currentTime = 0; // Start from beginning

            // Listen for video end to auto-redirect
            const onVideoEnd = () => {
              if (!hasRedirected) {
                hasRedirected = true;
                document.body.classList.add("fade-out");
                setTimeout(() => {
                  window.location.href = "asterisk.html";
                }, 300);
              }
            };
            mainVideo.addEventListener("ended", onVideoEnd, { once: true });

            // Play the video smoothly
            const playPromise = mainVideo.play();
            if (playPromise !== undefined) {
              playPromise
                .then(() => {
                  // Video is playing smoothly
                  console.log("Main video playing");
                })
                .catch((err) => {
                  console.warn("Failed to play main video:", err);
                  // Retry after a short delay
                  setTimeout(() => {
                    mainVideo.play().catch(() => {});
                  }, 100);
                });
            }
          };

          // Wait for video to be ready if needed
          if (mainVideo.readyState >= 3) {
            // Video has enough data to play
            playMainVideo();
          } else {
            // Wait for video to load
            const onCanPlay = () => {
              mainVideo.removeEventListener("canplay", onCanPlay);
              mainVideo.removeEventListener("canplaythrough", onCanPlay);
              playMainVideo();
            };
            mainVideo.addEventListener("canplay", onCanPlay, { once: true });
            mainVideo.addEventListener("canplaythrough", onCanPlay, {
              once: true,
            });

            // Force load if not already loading
            if (mainVideo.readyState === 0) {
              mainVideo.load();
            }
          }

          // Stop and hide pre-video after transition
          setTimeout(() => {
            preVideo.pause();
            preVideo.style.display = "none";
          }, 600); // Match transition duration
        }

        // Listen for click on pre-video
        preVideo.addEventListener("click", transitionToMainVideo);

        // Also allow clicking anywhere on overlay (except skip button)
        overlay.addEventListener("click", (e) => {
          // Only trigger if clicking the overlay itself or pre-video, not the skip button
          if (
            (e.target === overlay || e.target === preVideo) &&
            !hasTransitioned
          ) {
            transitionToMainVideo();
          }
        });

        // Ensure pre-video starts playing (in case autoplay is blocked)
        preVideo.play().catch(() => {
          console.log(
            "Autoplay blocked for pre-video, waiting for user interaction"
          );
        });

        // Preload main video in the background for smooth transition
        mainVideo.load();

        // Ensure main video is ready when needed
        if (mainVideo.readyState < 2) {
          mainVideo.addEventListener(
            "loadedmetadata",
            () => {
              console.log("Main video metadata loaded");
            },
            { once: true }
          );
        }

        // Smooth scroll physics
        function updateScroll() {
          const now = performance.now();
          const dt = Math.min(1, (now - lastFrameTime) / 16.67);
          lastFrameTime = now;

          // Only process scroll if we've transitioned to main video
          if (hasTransitioned) {
            const diff = targetScroll - scrollAccumulator;
            scrollVelocity += diff * 0.16 * dt;
            scrollVelocity *= 0.68;
            scrollAccumulator += scrollVelocity * dt;
            scrollAccumulator = Math.max(
              0,
              Math.min(maxScroll, scrollAccumulator)
            );

            // IMPORTANT: Don't scrub the video - let it play smoothly
            // Scroll only controls the fade and redirect, not video playback
            // The video should play normally from start to finish

            // Calculate fade progress - only fade after threshold
            let opacity = 1;
            if (scrollAccumulator >= fadeStartThreshold) {
              const fadeProgress =
                (scrollAccumulator - fadeStartThreshold) /
                (maxScroll - fadeStartThreshold);
              opacity = 1 - Math.min(1, fadeProgress);
            }

            // Apply fade
            overlay.style.opacity = opacity.toFixed(3);
            mainVideo.style.opacity = opacity.toFixed(3);

            // Redirect when scroll reaches end
            if (scrollAccumulator >= maxScroll - 2 && !hasRedirected) {
              hasRedirected = true;
              document.body.classList.add("fade-out");
              setTimeout(() => {
                window.location.href = "asterisk.html";
              }, 300);
            }
          }

          requestAnimationFrame(updateScroll);
        }

        // Start animation loop
        updateScroll();

        // Scroll handlers
        function nudgeScroll(delta) {
          // Ignore scroll until user clicks to transition from pre-video to main video
          if (!hasTransitioned) {
            return; // Do nothing - user must click to transition
          }

          targetScroll += delta;
          targetScroll = Math.max(0, Math.min(maxScroll, targetScroll));
        }

        // Wheel
        window.addEventListener(
          "wheel",
          (e) => {
            e.preventDefault();
            nudgeScroll(e.deltaY > 0 ? 8 : -8);
          },
          { passive: false }
        );

        // Touch
        let lastTouchY = null;
        window.addEventListener("touchstart", (e) => {
          if (e.touches.length === 1) lastTouchY = e.touches[0].clientY;
        });
        window.addEventListener(
          "touchmove",
          (e) => {
            if (e.touches.length !== 1 || lastTouchY === null) return;
            const dy = lastTouchY - e.touches[0].clientY;
            lastTouchY = e.touches[0].clientY;
            e.preventDefault();
            nudgeScroll(dy > 0 ? 8 : -8);
          },
          { passive: false }
        );

        // Keyboard
        window.addEventListener("keydown", (e) => {
          if (e.key === "ArrowDown" || e.key === "PageDown" || e.key === " ") {
            e.preventDefault();
            nudgeScroll(8);
          }
          if (e.key === "ArrowUp" || e.key === "PageUp") {
            e.preventDefault();
            nudgeScroll(-8);
          }
        });

        // Double-tap to skip (mobile)
        let lastTapTime = 0;
        overlay.addEventListener("touchend", (e) => {
          const now = performance.now();
          if (now - lastTapTime < 300) {
            e.preventDefault();
            targetScroll = maxScroll;
          }
          lastTapTime = now;
        });

        // Skip button functionality
        const skipBtn = document.getElementById("skipVideoBtn");
        if (skipBtn) {
          skipBtn.addEventListener("click", (e) => {
            e.stopPropagation(); // Prevent triggering overlay click
            e.preventDefault();
            // If still on pre-video, transition first
            if (!hasTransitioned) {
              transitionToMainVideo();
              // Wait for transition, then skip
              setTimeout(() => {
                targetScroll = maxScroll;
                scrollAccumulator = maxScroll;
              }, 650);
            } else {
              // Instantly jump to max scroll to trigger redirect
              targetScroll = maxScroll;
              scrollAccumulator = maxScroll;
            }
          });
        }
      })();
    </script>
  </body>
</html>
